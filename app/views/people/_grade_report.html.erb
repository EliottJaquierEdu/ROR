<%# Grade Report Component %>
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <h5 class="card-title mb-0">Grade Report</h5>
  </div>
  <div class="card-body">
    <% if student.grades.any? %>
      <% sorted_terms = student.sorted_terms %>
      
      <% if sorted_terms.any? %>
        <ul class="nav nav-tabs mb-3" id="gradesTab" role="tablist">
          <% sorted_terms.each_with_index do |term, index| %>
            <li class="nav-item" role="presentation">
              <button class="nav-link <%= index == 0 ? 'active' : '' %>" 
                      id="<%= term.parameterize %>-tab" 
                      data-bs-toggle="tab" 
                      data-bs-target="#<%= term.parameterize %>" 
                      type="button" 
                      role="tab" 
                      aria-controls="<%= term.parameterize %>" 
                      aria-selected="<%= index == 0 ? 'true' : 'false' %>">
                <%= term %>
              </button>
            </li>
          <% end %>
        </ul>
        
        <div class="tab-content" id="gradesTabContent">
          <% sorted_terms.each_with_index do |term, index| %>
            <div class="tab-pane fade <%= index == 0 ? 'show active' : '' %>" 
                 id="<%= term.parameterize %>" 
                 role="tabpanel" 
                 aria-labelledby="<%= term.parameterize %>-tab">
              
              <% term_grades = student.grades_by_term[term] %>
              <% grades_by_subject = group_term_grades_by_subject(term_grades) %>
              
              <div class="table-responsive mb-4">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Subject</th>
                      <th>Average Grade</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% grades_by_subject.each do |subject, subject_grades| %>
                      <% average_grade = calculate_average_grade(subject_grades) %>
                      <tr>
                        <td><%= link_to subject.name, subject %></td>
                        <td>
                          <span class="badge <%= grade_status_class(average_grade) %>">
                            <%= format_grade(average_grade) %>
                          </span>
                        </td>
                        <td>
                          <button class="btn btn-sm btn-outline-info" type="button" 
                                  data-bs-toggle="collapse" 
                                  data-bs-target="#details-<%= term.parameterize %>-<%= subject.id %>" 
                                  aria-expanded="false">
                            Show Details
                          </button>
                        </td>
                      </tr>
                      <tr>
                        <td colspan="3" class="p-0">
                          <div class="collapse" id="details-<%= term.parameterize %>-<%= subject.id %>">
                            <div class="p-3">
                              <table class="table table-sm table-hover mb-0">
                                <thead>
                                  <tr>
                                    <th>Examination</th>
                                    <th>Value</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% subject_grades.each do |grade| %>
                                    <tr>
                                      <td>
                                        <% if grade.examination %>
                                          <%= link_to grade.examination.title, grade.examination %>
                                        <% end %>
                                      </td>
                                      <td>
                                        <span class="badge <%= grade_status_class(grade.value) %>">
                                          <%= grade.value %>
                                        </span>
                                      </td>
                                      <td><%= grade.effective_date&.strftime("%d %b %Y") %></td>
                                      <td>
                                        <div class="btn-group btn-group-sm">
                                          <%= link_to grade, class: "btn btn-outline-primary" do %>
                                            <i class="bi bi-eye"></i> View
                                          <% end %>
                                        </div>
                                      </td>
                                    </tr>
                                  <% end %>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              
              <% term_average = student.term_average(term) %>
              <% if term_average > 0 %>
                <div class="alert <%= grade_status_class(term_average) %> d-flex align-items-center">
                  <div>
                    <strong>Term Average:</strong> <%= format_grade(term_average) %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-muted mb-0">No grades organized by terms.</p>
      <% end %>
    <% else %>
      <p class="text-muted mb-0">No grades recorded yet.</p>
    <% end %>
  </div>
</div> 