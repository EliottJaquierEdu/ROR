<%# Grade Report Component %>
<%# Print-specific styles %>
<style media="print">
    @media print {
        @page {
            size: A4;
            margin: 10mm;
        }

        /* Hide all UI elements that shouldn't be printed */
        .print-button, nav, footer, header,
        .student-info, .address,
        label[for="selected_class"], /* Hide class label */
        select[name="selected_class"], /* Hide class dropdown */
        .d-flex.align-items-center.gap-3, /* Hide class selection wrapper */
        button, /* Hide ALL buttons */
        input[type="button"],
        input[type="submit"],
        input[type="reset"],
        .btn, /* Hide any elements using Bootstrap .btn */
        [onclick], /* Hide elements with JS event handlers */
        [type="button"],
        [type="submit"],
        [role="button"],
        .card:not(:has(.card-title:contains("Grade Report"))) { /* Hide other cards */
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            max-height: 0 !important;
            max-width: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
        }

        /* Ensure Grade Report takes full width */
        main, .card {
            display: block !important;
            visibility: visible !important;
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 10px !important;
            box-sizing: border-box;
        }

        /* Full-width table */
        .table {
            width: 100% !important;
            border-collapse: collapse !important;
        }

        .table td, .table th {
            border: 1px solid black !important;
            padding: 5px !important;
            text-align: left;
        }

        /* Ensure readable text */
        td, th, a {
            color: black !important;
        }

        /* Improve badge visibility */
        .badge {
            color: black !important;
            border: 1px solid black !important;
        }
    }


</style>

<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Grade Report</h5>
      <div class="d-flex align-items-center gap-3">
        <button onclick="window.print()" class="btn btn-outline-secondary btn-sm print-button">
          <i class="bi bi-printer"></i> Print Report
        </button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <% if student.grades.any? %>
      <% student.sorted_terms.each do |term| %>
        <%# Get all grades for this term %>
        <% all_term_grades = student.grades_with_associations.select { |g| g.examination&.course&.term&.name == term } %>
        
        <%# Group grades by subject %>
        <% grades_by_subject = group_term_grades_by_subject(all_term_grades) %>
        
        <%# Term Header %>
        <div class="mb-4">
          <h6 class="text-primary mb-3">
            <i class="bi bi-calendar3"></i>
            <%= term %>
          </h6>
          
          <%# Term Grades Table %>
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>Subject</th>
                  <th>Examination</th>
                  <th>Grade</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <% grades_by_subject.each do |subject, subject_grades| %>
                  <%# Check if these grades are from a failed year %>
                  <% is_failed_year = subject_grades.any? { |g| student.failed_period_grades.include?(g) } %>
                  
                  <%# Display warning for failed year grades %>
                  <% if is_failed_year %>
                    <tr class="table-warning" style="opacity: 0.5;">
                      <td colspan="4">
                        <small class="text-muted">
                          <i class="bi bi-exclamation-triangle"></i>
                          The following grades are from a failed school year and do not count towards the overall performance:
                        </small>
                      </td>
                    </tr>
                  <% end %>
                  
                  <%# Display grades %>
                  <% subject_grades.each do |grade| %>
                    <tr style="<%= is_failed_year ? 'opacity: 0.5; background-color: #fff3cd;' : '' %>">
                      <td><%= link_to subject.name, subject %></td>
                      <td>
                        <% if grade.examination %>
                          <%= link_to grade.examination.title, grade.examination %>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge <%= grade_status_class(grade.value) %>">
                          <%= format_grade(grade.value) %>
                        </span>
                      </td>
                      <td><%= grade.effective_date&.strftime("%d %b %Y") %></td>
                    </tr>
                  <% end %>
                  
                  <%# Subject average row %>
                  <tr class="<%= is_failed_year ? 'table-warning' : 'table-light' %>" <%= 'style="opacity: 0.5;"' if is_failed_year %>>
                    <td colspan="2" class="text-end"><strong>Subject Average:</strong></td>
                    <td colspan="2">
                      <% average_grade = calculate_average_grade(subject_grades) %>
                      <span class="badge <%= grade_status_class(average_grade) %>">
                        <%= format_grade(average_grade) %>
                      </span>
                    </td>
                  </tr>
                <% end %>
                
                <%# Term average row %>
                <tr class="table-secondary">
                  <td colspan="2" class="text-end"><strong>Term Average:</strong></td>
                  <td colspan="2">
                    <% term_average = student.term_average(term) %>
                    <span class="badge <%= grade_status_class(term_average) %>">
                      <%= format_grade(term_average) %>
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>
      
      <%# Overall Summary Section %>
      <div class="mt-4 p-3 bg-light rounded border">
        <h6 class="mb-3 text-primary">Academic Performance Summary</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card h-100 border-0 bg-white shadow-sm">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Overall Performance</h6>
                <div class="d-flex align-items-center">
                  <span class="h4 mb-0 me-2">
                    <span class="badge <%= grade_status_class(student.overall_average(params[:selected_class])) %>">
                      <%= format_grade(student.overall_average(params[:selected_class])) %>
                    </span>
                  </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <p class="text-muted mb-0">No grades recorded yet.</p>
    <% end %>
  </div>
</div> 